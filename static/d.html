<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video İndir</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 600px; margin: 0 auto; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .subtitle { color: #888; font-size: 14px; margin-bottom: 20px; }
    .buttons { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    button {
      flex: 1;
      min-width: 140px;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
    button:disabled { opacity: 0.5; cursor: wait; }
    .btn-green { background: #0f0; color: #000; }
    .btn-blue { background: #0070f3; color: #fff; }
    .btn-gray { background: #333; color: #fff; }
    .video-list { display: flex; flex-direction: column; gap: 8px; }
    .video-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 8px;
      border: 1px solid #333;
    }
    .video-item.downloaded { background: #1a2a1a; border-color: #0f0; }
    .video-name {
      flex: 1;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 12px;
    }
    .video-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .parts-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }
    .part-btn {
      padding: 12px 16px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      text-align: center;
    }
    .loading { text-align: center; padding: 40px; }
    .error { text-align: center; padding: 40px; color: #f00; }
  </style>
</head>
<body>
  <div class="container">
    <div id="content">
      <div class="loading">Yükleniyor...</div>
    </div>
  </div>

  <script>
    const id = window.location.pathname.split('/').pop();
    let videos = [];
    let downloaded = new Set();

    async function init() {
      try {
        const res = await fetch(`/api/collection/${id}`);
        if (!res.ok) {
          document.getElementById('content').innerHTML = '<div class="error">Koleksiyon bulunamadı</div>';
          return;
        }

        const data = await res.json();
        videos = data.items;
        render();
      } catch (err) {
        document.getElementById('content').innerHTML = '<div class="error">Bir hata oluştu</div>';
      }
    }

    function render(state = {}) {
      const { zipping, progress, zipReady, zipParts } = state;

      let buttonsHTML = '';

      if (zipParts && zipParts.length > 0) {
        buttonsHTML = `
          <div class="parts-container">
            ${zipParts.map(p => `
              <button class="part-btn" onclick="window.location.href='${p.url}'">
                Parça ${p.partNumber} (${p.sizeFormatted})
              </button>
            `).join('')}
          </div>
        `;
      } else if (zipReady) {
        buttonsHTML = `
          <button class="btn-green" onclick="window.location.href='${zipReady.url}'">
            ZIP İndir
          </button>
        `;
      } else {
        buttonsHTML = `
          <button class="btn-blue" onclick="startZip()" ${zipping ? 'disabled' : ''}>
            ${zipping ? (progress ? `${progress.current}/${progress.total}` : 'Başlıyor...') : 'ZIP Hazırla'}
          </button>
        `;
      }

      document.getElementById('content').innerHTML = `
        <h1>${videos.length} Video</h1>
        <p class="subtitle">${downloaded.size} / ${videos.length} indirildi</p>

        <div class="buttons">
          <button class="btn-green" onclick="downloadAll()" ${zipping ? 'disabled' : ''}>
            Tek Tek İndir
          </button>
          ${buttonsHTML}
        </div>

        <div class="video-list">
          ${videos.map((v, i) => `
            <div class="video-item ${downloaded.has(i) ? 'downloaded' : ''}">
              <span class="video-name">${v.filename}</span>
              <button class="video-btn ${downloaded.has(i) ? 'btn-green' : 'btn-gray'}"
                      onclick="downloadSingle(${i})">
                ${downloaded.has(i) ? 'Tamam' : 'İndir'}
              </button>
            </div>
          `).join('')}
        </div>
      `;
    }

    function downloadSingle(index) {
      const video = videos[index];
      const a = document.createElement('a');
      a.href = `/api/download?url=${encodeURIComponent(video.url)}&filename=${encodeURIComponent(video.filename)}`;
      a.download = video.filename;
      a.click();
      downloaded.add(index);
      render();
    }

    async function downloadAll() {
      for (let i = 0; i < videos.length; i++) {
        downloadSingle(i);
        await new Promise(r => setTimeout(r, 800));
      }
    }

    function startZip() {
      render({ zipping: true });

      const eventSource = new EventSource(`/api/zip/${id}`);

      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'start') {
          render({ zipping: true, progress: { current: 0, total: data.total } });
        } else if (data.type === 'progress') {
          render({ zipping: true, progress: { current: data.current, total: data.total } });
        } else if (data.type === 'complete') {
          eventSource.close();
          render({ zipReady: { url: data.downloadUrl } });
        } else if (data.type === 'complete_multipart') {
          eventSource.close();
          render({ zipParts: data.parts });
        } else if (data.type === 'error') {
          eventSource.close();
          alert(data.message);
          render();
        }
      };

      eventSource.onerror = () => {
        eventSource.close();
        render();
      };
    }

    init();
  </script>
</body>
</html>
